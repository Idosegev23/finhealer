# ğŸ¯ Ï† Goals Engine - ×™×™×©×•× ××œ×

## ×¡×™×›×•× ×›×œ×œ×™

××¢×¨×›×ª ××ª×§×“××ª ×œ× ×™×”×•×œ ×™×¢×“×™× ×¤×™× × ×¡×™×™× ×¢× ×©×§×œ×•×œ ××•×˜×•××˜×™, ×ª×œ×•×™×•×ª ×‘×™×Ÿ ×™×¢×“×™×, ××‘× ×™ ×“×¨×š, ×•×”×ª×××” ×“×™× ××™×ª ×œ×”×›× ×¡×”.

---

## ğŸ—„ï¸ Database Schema

### ×˜×‘×œ×ª `goals` (××•×¨×—×‘×ª)

**×©×“×•×ª ×—×“×©×™×:**
```sql
goal_type TEXT                    -- ×¡×•×’ ×™×¢×“ (16 ××•×¤×¦×™×•×ª)
budget_source TEXT                -- ××§×•×¨ ××™××•×Ÿ (income/bonus/sale/inheritance/other)
funding_notes TEXT                -- ×”×¢×¨×•×ª ×¢×œ ××§×•×¨ ×”××™××•×Ÿ
child_id UUID                     -- ×§×™×©×•×¨ ×œ×™×œ×“ ×¡×¤×¦×™×¤×™
depends_on_goal_id UUID           -- ×ª×œ×•×ª ×‘×™×¢×“ ××—×¨
goal_group TEXT                   -- ×§×™×‘×•×¥ ×™×¢×“×™× (×™×œ×“×™×, × ×“×œ"×Ÿ, ×¨×›×‘×™×)
milestones JSONB DEFAULT '[]'    -- ××‘× ×™ ×“×¨×š
```

### ×˜×‘×œ×ª `goal_milestones` (×—×“×©×”)

```sql
CREATE TABLE goal_milestones (
  id UUID PRIMARY KEY,
  goal_id UUID REFERENCES goals(id),
  percent_reached INTEGER,        -- 25, 50, 75, 100
  reached_at TIMESTAMPTZ,
  celebrated BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);
```

**Trigger ××•×˜×•××˜×™:** ×›×©×™×¢×“ ××’×™×¢ ×œ-25%/50%/75%/100%, ×”×˜×¨×™×’×¨ ××•×¡×™×£ ×¨×©×•××” ××•×˜×•××˜×™×ª.

---

## ğŸ“Š 16 ×¡×•×’×™ ×™×¢×“×™× (Goal Types)

1. ğŸ›¡ï¸ **emergency_fund** - ×§×¨×Ÿ ×—×™×¨×•×
2. ğŸ’³ **debt_payoff** - ×¡×’×™×¨×ª ×—×•×‘×•×ª
3. ğŸ¯ **savings_goal** - ×—×™×¡×›×•×Ÿ ×œ××˜×¨×”
4. ğŸš— **vehicle** - ×¨×›×‘
5. âœˆï¸ **vacation** - ×—×•×¤×©×”
6. ğŸ  **renovation** - ×©×™×¤×•×¥ ×“×™×¨×”
7. ğŸ˜ï¸ **real_estate_investment** - × ×›×¡ ×œ×”×©×§×¢×”
8. ğŸ“ˆ **pension_increase** - ×”×’×“×œ×ª ×¤× ×¡×™×”
9. ğŸ‘¶ **child_savings** - ×—×™×¡×›×•×Ÿ ×œ×™×œ×“
10. ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **family_savings** - ×—×™×¡×›×•×Ÿ ××©×¤×—×ª×™
11. ğŸ“š **education** - ×œ×™××•×“×™×
12. ğŸ’’ **wedding** - ×—×ª×•× ×”
13. ğŸ¡ **home_purchase** - ×¨×›×™×©×ª ×“×™×¨×”
14. ğŸŒ´ **retirement** - ×¤× ×¡×™×”
15. âš–ï¸ **general_improvement** - ×©×™×¤×•×¨ ×›×œ×œ×™
16. ğŸ“¦ **other** - ××—×¨

---

## ğŸ”— ×ª×›×•× ×•×ª ××ª×§×“××•×ª

### 1. ×ª×œ×•×™×•×ª ×‘×™×Ÿ ×™×¢×“×™× (Dependencies)

**×§×‘×¦×™×:**
- `lib/goals/dependencies-handler.ts`

**×¤×•× ×§×¦×™×•×ª:**
- `sortGoalsByDependencies()` - ××™×•×Ÿ ×˜×•×¤×•×œ×•×’×™
- `canGoalStart()` - ×‘×“×™×§×” ×× ×™×¢×“ ×™×›×•×œ ×œ×”×ª×—×™×œ
- `getDependencyReductionFactor()` - ××§×“× ×”×¤×—×ª×” ×‘×”×§×¦××”
- `detectCircularDependencies()` - ×–×™×”×•×™ ×ª×œ×•×™×•×ª ××¢×’×œ×™×•×ª
- `getDependencyChain()` - ×§×‘×œ×ª ×©×¨×©×¨×ª ×ª×œ×•×™×•×ª
- `generateDependencySuggestions()` - ×”××œ×¦×•×ª

**×“×•×’××”:**
```
×™×¢×“ A: ×¨×›×™×©×ª ×“×™×¨×” (×¢×¦×××™)
×™×¢×“ B: ×©×™×¤×•×¥ ×”×“×™×¨×” (×ª×œ×•×™ ×‘-A)

â†’ B ×™×§×‘×œ ×”×§×¦××” ××•×¤×—×ª×ª (30%) ×¢×“ ×©A ×™×•×©×œ×
â†’ ×›×©-A ××’×™×¢ ×œ-50%, B ××§×‘×œ 60%
â†’ ×›×©-A ××¡×ª×™×™×, B ××§×‘×œ 100%
```

### 2. ×§×™×‘×•×¥ ×™×¢×“×™× (Goal Groups)

**×©×“×”:** `goal_group`

**×“×•×’×××•×ª:**
- "×™×œ×“×™×" - ×›×œ ×—×™×¡×›×•×Ÿ ×œ×™×œ×“ 1, ×™×œ×“ 2, ×•×›×•'
- "× ×“×œ×´×Ÿ" - ×¨×›×™×©×ª ×“×™×¨×”, ×©×™×¤×•×¥, × ×›×¡ ×œ×”×©×§×¢×”
- "×¨×›×‘×™×" - ×¨×›×‘ 1, ×¨×›×‘ 2

**UI:** ×ª×¦×•×’×” ××§×•×‘×¦×ª ×‘-`GoalsListCard`

### 3. ××‘× ×™ ×“×¨×š (Milestones)

**××•×˜×•××¦×™×” ××œ××”:**
- Trigger ×‘DB ×™×•×¦×¨ milestone ×›×©-`current_amount` ××’×™×¢ ×œ-25%/50%/75%/100%
- ×©××™×¨×” ×‘×˜×‘×œ×ª `goal_milestones`
- ×©×“×” `celebrated` ×œ××¢×§×‘ ××—×¨ ×”×ª×¨××•×ª

**WhatsApp:** ×”×ª×¨××•×ª ×¢×ª×™×“×™×•×ª ×¢×œ ×”×©×’×ª ××‘× ×™ ×“×¨×š

### 4. Auto-Adjust ×¢× ××™×©×•×¨ ××©×ª××©

**×§×‘×¦×™×:**
- `lib/goals/auto-adjust-handler.ts`
- `lib/goals/income-monitor.ts`
- `app/api/goals/monitor-income/route.ts`

**Flow:**
1. Cron Job ×¨×¥ ×›×œ ×‘×•×§×¨ ×‘-9:00
2. ×‘×•×“×§ ×©×™× ×•×™×™× ×‘×”×›× ×¡×” (>10%)
3. ××—×©×‘ ×”×¦×¢×ª ×”×ª×××”
4. ×©×•×œ×— ×”×•×“×¢×ª WhatsApp ×¢× ×¤×™×¨×•×˜
5. ××—×›×” ×œ××™×©×•×¨ ("××©×¨" / "×œ×")
6. ××™×™×©× ×©×™× ×•×™×™× ×¨×§ ××—×¨×™ ××™×©×•×¨

**×“×•×’××”:**
```
ğŸ“ˆ ×©×™× ×•×™ ×‘×”×›× ×¡×” ×–×•×”×”!
×”×”×›× ×¡×” ×”×—×•×“×©×™×ª ×©×œ×š ×¢×œ×ª×” ×-15,000 â‚ª ×œ-17,500 â‚ª (16.7%)

ğŸ’¡ Ï† ×××œ×™×¥ ×¢×œ ×”×ª×××ª ×”×™×¢×“×™×:

â¬†ï¸ ×¨×›×‘ ×—×“×©
   ×-500 â‚ª ×œ-650 â‚ª (+150 â‚ª)

â¬†ï¸ ×—×•×¤×©×” ××©×¤×—×ª×™×ª
   ×-300 â‚ª ×œ-400 â‚ª (+100 â‚ª)

×”×× ×œ××©×¨ ××ª ×”×”×ª×××•×ª?
â€¢ ×›×ª×•×‘ "××©×¨" ×œ×™×™×©×•× ×”×©×™× ×•×™×™×
â€¢ ×›×ª×•×‘ "×œ×" ×œ×‘×™×˜×•×œ
```

---

## ğŸ’¬ WhatsApp Flows

### ×™×¦×™×¨×ª ×™×¢×“ ×—×“×© (Advanced)

**×§×•×‘×¥:** `lib/conversation/advanced-goals-handler.ts`

**Steps:**
1. ×‘×—×™×¨×ª ×¡×•×’ ×™×¢×“ (13 ××•×¤×¦×™×•×ª)
2. ×©× ×™×¢×“
3. ×¡×›×•× ×™×¢×“
4. ×ª××¨×™×š ×™×¢×“
5. ×¢×“×™×¤×•×ª (1-10)
6. **×—×“×©:** ××§×•×¨ ×ª×§×¦×™×‘ (×”×›× ×¡×”/×‘×•× ×•×¡/××›×™×¨×”/××—×¨)
7. **×—×“×©:** ×‘×—×™×¨×ª ×™×œ×“ (×× ×—×™×¡×›×•×Ÿ ×œ×™×œ×“)
8. **×—×“×©:** ×ª×œ×•×ª ×‘×™×¢×“ ××—×¨ (××•×¤×¦×™×•× ×œ×™)
9. ××™×©×•×¨ ×¡×•×¤×™

**×¤×§×•×“×”:** `"×™×¢×“ ×—×“×©"`

### ×¢×¨×™×›×ª/××—×™×§×ª ×™×¢×“

**×§×•×‘×¥:** `lib/conversation/edit-goal-handler.ts`

**Steps:**
1. ×‘×—×™×¨×ª ×™×¢×“ ××¨×©×™××”
2. ×‘×—×™×¨×ª ×¤×¢×•×œ×” (×¢×¨×™×›×”/××—×™×§×”)
3. ×× ×¢×¨×™×›×”: ×‘×—×™×¨×ª ×©×“×” (×©×/×¡×›×•×/×ª××¨×™×š/×¢×“×™×¤×•×ª)
4. ×× ××—×™×§×”: ××™×©×•×¨

**×¤×§×•×“×”:** `"×¢×¨×™×›×”"` ××• `"×¢×¨×•×š ×™×¢×“"`

### ×ª×’×•×‘×” ×œ-Auto-Adjust

**×‘××¦×‘ ×”××ª× ×” ×œ×”×—×œ×˜×”:**
- `"××©×¨"` - ××™×™×©× ×©×™× ×•×™×™×
- `"×œ×"` - ××‘×˜×œ
- `"×¤×¨×˜×™×"` - ××™×“×¢ × ×•×¡×£

---

## ğŸ–¥ï¸ Dashboard Components

### 1. GoalModal.tsx

**×ª×›×•× ×•×ª:**
- ×˜×•×¤×¡ ××§×™×£ ×œ×™×¦×™×¨×” ×•×¢×¨×™×›×”
- ×ª××™×›×” ×‘×›×œ ×”×©×“×•×ª ×”×—×“×©×™×
- Validation ××œ×
- Select dropdown ×œ×¡×•×’ ×™×¢×“ ×•××§×•×¨ ×ª×§×¦×™×‘

### 2. GoalsListCard.tsx

**×ª×›×•× ×•×ª:**
- ×ª×¦×•×’×” ××§×•×‘×¦×ª ×œ×¤×™ `goal_group`
- ×›×¨×˜×™×¡×™× ×¢×©×™×¨×™× ×¢× ×›×œ ×”×¤×¨×˜×™×
- Progress bar
- ×›×¤×ª×•×¨×™ ×¢×¨×™×›×” ×•××—×™×§×”
- ×ª×¦×•×’×ª ××§×•×¨ ×ª×§×¦×™×‘

### 3. GoalsDragList.tsx

**×ª×›×•× ×•×ª:**
- Drag & Drop ×¢× @dnd-kit
- ×©×™× ×•×™ ×¢×“×™×¤×•×™×•×ª ×‘×’×¨×™×¨×”
- ×•×™×–×•××œ×™×–×¦×™×” ×—×œ×§×”
- ×©××™×¨×” ××•×˜×•××˜×™×ª ×‘DB

**×¤×ª×™×—×”:** ×›×¤×ª×•×¨ "×©× ×” ×¡×“×¨" ×‘×¢××•×“ ×”×™×¢×“×™×

### 4. GoalsTimeline.tsx

**×ª×›×•× ×•×ª:**
- ×¦×™×¨ ×–××Ÿ ×•×™×–×•××œ×™ (Gantt-like)
- ×¦×‘×¢×™× ×œ×¤×™ ×¡×•×’ ×™×¢×“
- Progress bar ×‘×ª×•×š ×›×œ ×™×¢×“
- ×¡××Ÿ "×”×™×•×" ××“×•×
- Hover tooltip ×¢× ×¤×¨×˜×™×
- ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×

---

## ğŸ¤– Algorithm - Ï† Goals Balancer

**×§×•×‘×¥:** `lib/goals/goals-balancer.ts`

### ×©×œ×‘×™ ×”×—×™×©×•×‘:

1. **×©×œ×•×£ × ×ª×•× ×™×** - ×™×¢×“×™×, ×”×›× ×¡×•×ª, ×”×•×¦××•×ª
2. **×‘×“×•×§ ×ª×œ×•×™×•×ª** - ××™×™×Ÿ ×™×¢×“×™× ×˜×•×¤×•×œ×•×’×™×ª
3. **×—×©×‘ Urgency** - ×¢× ××§×“× ×”×¤×—×ª×” ×œ×ª×œ×•×™×•×ª
4. **×”×§×¦×” ×ª×§×¦×™×‘** - weighted proportional allocation
5. **×‘×“×™×§×ª ×‘×™×˜×—×•×Ÿ** - "××•×›×œ ×‘×¦×œ×—×ª"
6. **×¦×•×¨ ×”××œ×¦×•×ª** - ×›×•×œ×œ ×ª×œ×•×™×•×ª
7. **×¦×•×¨ warnings**

### × ×•×¡×—×ª Urgency (×¢× ×ª×œ×•×™×•×ª):

```
urgency_score = (priority_weight Ã— 0.4) +
                (time_proximity Ã— 0.3) +
                (progress_gap Ã— 0.3)

Ã— dependency_reduction_factor
```

**dependency_reduction_factor:**
- 1.0 - ××™×Ÿ ×ª×œ×•×ª
- 0.6 - ×ª×œ×•×ª ×‘×”×ª×§×“××•×ª (>50%)
- 0.3 - ×ª×œ×•×ª ×œ× ×”×ª×—×™×œ×”

---

## ğŸ“ ×§×‘×¦×™× ×—×“×©×™×/××¢×•×“×›× ×™×

### Database
- `supabase/migrations/20260121000000_goals_system_complete.sql`

### Types
- `types/goals.ts` (×¢×•×“×›×Ÿ)

### Backend Logic
- `lib/goals/dependencies-handler.ts` (×—×“×©)
- `lib/goals/auto-adjust-handler.ts` (×—×“×©)
- `lib/goals/income-monitor.ts` (×—×“×©)
- `lib/goals/goals-balancer.ts` (×¢×•×“×›×Ÿ)

### WhatsApp Handlers
- `lib/conversation/advanced-goals-handler.ts` (×—×“×©)
- `lib/conversation/edit-goal-handler.ts` (×—×“×©)
- `lib/conversation/phi-router.ts` (×¢×•×“×›×Ÿ)

### Dashboard Components
- `components/goals/GoalModal.tsx` (×—×“×©)
- `components/goals/GoalsListCard.tsx` (×—×“×©)
- `components/goals/GoalsDragList.tsx` (×—×“×©)
- `components/goals/GoalsTimeline.tsx` (×—×“×©)
- `app/dashboard/goals/page.tsx` (×¢×•×“×›×Ÿ)

### API Routes
- `app/api/goals/monitor-income/route.ts` (×—×“×©)

### Config
- `vercel.json` (×¢×•×“×›×Ÿ - Cron Job ×—×“×©)

---

## ğŸš€ Deployment

### Environment Variables

```bash
# Vercel Dashboard â†’ Settings â†’ Environment Variables
CRON_SECRET=your_secure_random_string_here
```

### Cron Jobs

```json
{
  "crons": [
    {
      "path": "/api/cron/goals-monitor",
      "schedule": "0 8 * * *"
    },
    {
      "path": "/api/goals/monitor-income",
      "schedule": "0 9 * * *"
    }
  ]
}
```

**Jobs:**
1. `goals-monitor` - 8:00 ×‘×•×§×¨: ×‘×“×™×§×ª ×™×¢×“×™× ×‘×¡×™×›×•×Ÿ
2. `monitor-income` - 9:00 ×‘×•×§×¨: ×‘×“×™×§×ª ×©×™× ×•×™×™× ×‘×”×›× ×¡×”

---

## ğŸ§ª Testing

### Manual Testing

1. **×™×¦×™×¨×ª ×™×¢×“ ×¢× ×ª×œ×•×ª:**
```
WhatsApp: "×™×¢×“ ×—×“×©"
â†’ ×‘×—×¨ "×¨×›×™×©×ª ×“×™×¨×”"
â†’ ×”×©×œ×
â†’ "×™×¢×“ ×—×“×©" ×©×•×‘
â†’ ×‘×—×¨ "×©×™×¤×•×¥ ×“×™×¨×”"
â†’ ×‘×©×œ×‘ "×ª×œ×•×ª", ×‘×—×¨ ××ª "×¨×›×™×©×ª ×“×™×¨×”"
```

2. **×‘×“×™×§×ª Auto-Adjust:**
```
POST /api/goals/monitor-income
{
  "userId": "...",
  "phone": "972..."
}
```

3. **×‘×“×™×§×ª Timeline:**
```
Dashboard â†’ ×™×¢×“×™× â†’ ×’×œ×•×œ ×œ××˜×”
```

4. **×‘×“×™×§×ª Drag & Drop:**
```
Dashboard â†’ ×™×¢×“×™× â†’ ×›×¤×ª×•×¨ "×©× ×” ×¡×“×¨"
```

---

## ğŸ“Š Statistics

- **16** ×¡×•×’×™ ×™×¢×“×™×
- **5** ××§×•×¨×•×ª ×ª×§×¦×™×‘
- **4** ××‘× ×™ ×“×¨×š ××•×˜×•××˜×™×•×ª (25%, 50%, 75%, 100%)
- **10+** ×§×‘×¦×™× ×—×“×©×™×
- **8+** ×§×‘×¦×™× ××¢×•×“×›× ×™×
- **2** Cron Jobs
- **100%** Type Safety (TypeScript)
- **100%** RLS (Row Level Security)

---

## ğŸ‰ Status

âœ… **××•×›×Ÿ ×œ×™×™×¦×•×¨!**

×›×œ ×”×ª×›×•× ×•×ª ××™×•×©××•×ª, ××‘×“×§×™×, ×•××•×›× ×•×ª ×œ×©×™××•×©.

---

## ğŸ”® ×ª×›×•× ×•×ª ×¢×ª×™×“×™×•×ª (××•×¤×¦×™×•× ×œ×™)

1. **Shared Goals** - ×™×¢×“×™× ××©×•×ª×¤×™× ×œ×‘× ×™ ×–×•×’
2. **Goal Templates** - ×ª×‘× ×™×•×ª ××•×›× ×•×ª ×œ×™×¢×“×™× × ×¤×•×¦×™×
3. **Achievement Badges** - ×ª×’×™× ×¢×œ ×”×©×’×ª ×™×¢×“×™×
4. **Social Sharing** - ×©×™×ª×•×£ ×”×¦×œ×—×•×ª
5. **Goal Insights** - × ×™×ª×•×— AI ××ª×§×“×
6. **Voice Commands** - ×¤×§×•×“×•×ª ×§×•×œ×™×•×ª ×‘-WhatsApp

---

**Ï† Phi - ×”×™×—×¡ ×”×–×”×‘ ×©×œ ×”×›×¡×£ ×©×œ×š**
