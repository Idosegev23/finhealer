# φ Goals Balancer - מנוע שקלול יעדים חכם

## סקירה כללית

מנוע שקלול יעדים חכם שמאזן בין מטרות פיננסיות מרובות, תוך שמירה על "אוכל בצלחת" ושקיפות מלאה למשתמש.

## ✨ מה חדש?

### 1. מבנה נתונים מורחב

**טבלת `goals` - שדות חדשים:**
- `start_date` - תאריך התחלת היעד
- `is_flexible` - האם ניתן להפחית/להגדיל הקצאה
- `min_allocation` - הקצאה מינימלית מובטחת
- `monthly_allocation` - הקצאה מחושבת (מתעדכן אוטומטית)
- `auto_adjust` - כיוונון אוטומטי כשהכנסות משתנות
- `metadata` - נתונים נוספים (JSON)

**טבלאות חדשות:**
- `goal_allocations_history` - היסטוריית שינויי הקצאות (למעקב ולמידה)
- `user_income_forecast` - חיזוי הכנסות עתידיות (לתכנון יעדים)

### 2. אלגוריתם השקלול (φ Goals Balancer)

**עקרונות:**
1. **"אוכל בצלחת" קודם** - מבטיח שנשאר מינימום 30% למחיה
2. **חישוב דחיפות (Urgency Score)** - משקלל עדיפות + קרבה לדדליין + פער התקדמות
3. **Weighted Proportional Allocation** - חלוקה אופטימלית לפי משקלים
4. **מינימום מובטח** - כל יעד מקבל לפחות `min_allocation`
5. **מקסימום סביר** - אף יעד לא יכול לקבל יותר מ-40% מהתקציב

**נוסחת דחיפות:**
```
urgencyScore = (priority × 0.4) + (timeProximity × 0.4) + (progressGap × 0.2)
```

**תהליך ההקצאה:**
```
1. חשב הכנסה זמינה = הכנסה - הוצאות קבועות - מינימום מחיה - מרווח ביטחון
2. סיבוב 1: הקצה מינימום מובטח לכל יעד
3. סיבוב 2: חלק יתרה לפי משקלי דחיפות
4. סיבוב 3: תיקוני עדינות (העבר עודפים, הגבל מקסימום)
5. ודא safety check - שנשאר מספיק למחיה
```

### 3. API Endpoints

#### `POST /api/goals/balance`
מחשב הקצאות אופטימליות ליעדים.

**Request:**
```json
{
  "userId": "uuid",
  "monthlyIncome": 15000,  // אופציונלי - לסימולציה
  "fixedExpenses": 8000,   // אופציונלי
  "applyChanges": true     // האם להחיל בפועל
}
```

**Response:**
```json
{
  "success": true,
  "result": {
    "allocations": [
      {
        "goal_id": "...",
        "goal_name": "קרן חירום",
        "monthly_allocation": 2000,
        "months_to_complete": 15,
        "is_achievable": true,
        "urgency_score": 0.85,
        "warnings": []
      }
    ],
    "summary": {
      "total_income": 15000,
      "available_for_goals": 4500,
      "total_allocated": 4200,
      "achievable_goals": 3
    },
    "warnings": [],
    "suggestions": [
      {
        "type": "increase_income",
        "message": "אם תגדיל הכנסה ב-1,500 ₪...",
        "impact": "תשלים 2 יעדים מהר יותר",
        "priority": "medium"
      }
    ],
    "safetyCheck": {
      "passed": true,
      "comfort_level": "comfortable"
    }
  }
}
```

#### `POST /api/goals/simulate`
מריץ סימולציות "מה יקרה אם...".

**Request:**
```json
{
  "userId": "uuid",
  "scenario": {
    "type": "income_change",
    "income_change": 2000
  }
}
```

**Scenario Types:**
- `income_change` - שינוי בהכנסה
- `expense_change` - שינוי בהוצאות
- `new_goal` - הוספת יעד חדש
- `remove_goal` - הסרת יעד
- `priority_change` - שינוי עדיפויות

**Response:**
```json
{
  "success": true,
  "result": {
    "before": { /* תוצאות לפני */ },
    "after": { /* תוצאות אחרי */ },
    "impact_summary": {
      "goals_improved": 2,
      "goals_worsened": 0,
      "total_time_saved_months": 8,
      "recommendation": "✅ תרחיש חיובי! 2 יעדים ישתפרו 🎉"
    }
  }
}
```

### 4. WhatsApp - פקודות חדשות

#### `יעדים`
הצגה מתקדמת של כל היעדים עם הקצאות מחושבות.

```
🎯 היעדים שלך

💰 סה"כ הקצאה: 4,500 ₪/חודש
📊 מתוך הכנסה זמינה: 8,200 ₪

1️⃣ קרן חירום (עדיפות: גבוהה) 🔴
   יעד: 30,000 ₪ | נוכחי: 5,000 ₪
   הקצאה: 2,000 ₪/חודש
   ✅ סיום צפוי: יוני 2026

2️⃣ חופשה משפחתית ✈️ (עדיפות: בינונית) 🟡
   יעד: 15,000 ₪ | נוכחי: 3,000 ₪
   הקצאה: 1,500 ₪/חודש
   ✅ סיום צפוי: ספטמבר 2026

💡 המלצה: אם תגדיל הכנסה ב-1,500 ₪, תוכל להשלים קרן חירום ב-3 חודשים!

פקודות:
• "יעד חדש" - הוסף יעד
• "סימולציה" - מה יקרה אם...
• "אופטימיזציה" - הצע תכנית אופטימלית
```

#### `סימולציה`
הרצת תרחישי "מה אם" אינטראקטיביים.

```
📊 סימולציה - מה יקרה אם...

בחר תרחיש:

1️⃣ הכנסה עולה - ההכנסה שלי תעלה ב-X ₪
2️⃣ הכנסה יורדת - ההכנסה שלי תרד ב-X ₪
3️⃣ יעד חדש - אוסיף יעד חדש
4️⃣ שינוי עדיפות - אשנה סדר עדיפויות

כתוב מספר (1-4)
```

#### `אופטימיזציה`
המערכת מציעה שיפורים אוטומטיים.

```
🎯 תכנית אופטימלית מוצעת

מצאתי שיפור אפשרי בהקצאות!

שינויים מוצעים:
• קרן חירום: +500 ₪
• חופשה: -200 ₪
• רכב חדש: -300 ₪

💡 תוצאה: תשלים את קרן החירום 4 חודשים מוקדם יותר

האם לאשר את השינויים?

כתוב "אשר" או "בטל"
```

### 5. דשבורד - עמוד יעדים

**נגישות:** `/dashboard/goals`

**תכונות:**

#### סיכום כללי
4 כרטיסיות עם מטריקות מרכזיות:
- הכנסה חודשית
- זמין ליעדים
- סה"כ מוקצה
- מצב תקציבי (צבעוני)

#### סימולטור אינטראקטיבי
- **Slider** - משוך להגדלה/הקטנת הכנסה
- **הרץ סימולציה** - ראה השפעה מיידית
- **השוואה לפני/אחרי** - יעדים שישתפרו/יורעו
- **חיסכון בזמן** - כמה חודשים תחסוך

#### רשימת יעדים מפורטת
לכל יעד:
- שם + עדיפות (צבעוני)
- מד התקדמות (progress bar)
- יעד/נוכחי/נותר
- הקצאה חודשית
- חודשים לסיום
- תאריך סיום צפוי
- סטטוס (ניתן להשגה/קשה)
- אזהרות (אם יש)

#### המלצות φ
קלפים עם המלצות מותאמות אישית:
- סוג המלצה (צבע לפי עדיפות)
- הסבר מפורט
- השפעה צפויה

### 6. מערכת ניטור והתראות אוטומטית

**Cron Job:** רץ מדי יום ב-10:00

**בדיקות:**
1. **יעדים בסיכון** - לא יושלמו בזמן
2. **יעדים קרובים להשלמה** - פחות מחודש
3. **שינויים בהכנסה** - עלייה/ירידה משמעותית (>10%)
4. **תקציב צמוד** - נשאר מעט למחיה
5. **יעדים עצומים** - ללא התקדמות 3 חודשים
6. **אופטימיזציה כללית** - המלצות לשיפור

**דוגמאות להתראות:**

```
⚠️ היעד "קרן חירום" בסיכון! נשארו 25 ימים והוא לא יושלם בזמן.
💡 המלצה: הגדל הקצאה ל-2,500 ₪/חודש
```

```
🎉 כמעט סיימת! היעד "חופשה משפחתית" יושלם בחודש הבא!
```

```
💰 הכנסתך עלתה ב-2,000 ₪!
💡 המלצה: ניתן להגדיל הקצאות ליעדים או להוסיף יעד חדש
```

**ריאיזון אוטומטי:**
אם יעד מוגדר עם `auto_adjust: true`, המערכת תתאים הקצאות אוטומטית כשההכנסה משתנתה.

## 📁 מבנה הקבצים

```
types/
  goals.ts                          # טיפוסים TypeScript

lib/
  goals/
    goals-balancer.ts               # אלגוריתם השקלול המרכזי ⭐
    income-forecaster.ts            # חיזוי הכנסות עתידיות
    goals-monitor.ts                # מערכת ניטור והתראות
  
  conversation/
    goals-wa-handler.ts             # פונקציות WhatsApp מתקדמות
    phi-router.ts                   # עודכן עם פקודות חדשות

app/
  api/
    goals/
      balance/route.ts              # API לחישוב הקצאות
      simulate/route.ts             # API לסימולציות
    
    cron/
      goals-check/route.ts          # Cron job יומי
  
  dashboard/
    goals/page.tsx                  # עמוד יעדים בדשבורד ⭐

supabase/
  migrations/
    [timestamp]_expand_goals_table_for_balancer.sql
    [timestamp]_create_goal_allocations_history.sql
    [timestamp]_create_user_income_forecast.sql
```

## 🚀 שימוש

### בקוד (TypeScript)

```typescript
import { calculateOptimalAllocations } from '@/lib/goals/goals-balancer';
import { forecastIncome } from '@/lib/goals/income-forecaster';

// חישוב הקצאות
const result = await calculateOptimalAllocations({
  userId: 'user-uuid',
  monthlyIncome: 15000,  // אופציונלי
  fixedExpenses: 8000,   // אופציונלי
});

console.log(result.allocations);
console.log(result.suggestions);

// חיזוי הכנסות
const forecasts = await forecastIncome('user-uuid', {
  months: 12,
  includeSeasonality: true,
});
```

### API

```bash
# חישוב הקצאות
curl -X POST https://your-domain.com/api/goals/balance \
  -H "Content-Type: application/json" \
  -d '{"userId": "user-uuid"}'

# סימולציה
curl -X POST https://your-domain.com/api/goals/simulate \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user-uuid",
    "scenario": {
      "type": "income_change",
      "income_change": 2000
    }
  }'
```

### WhatsApp

```
משתמש: יעדים
בוט: 🎯 היעדים שלך...

משתמש: סימולציה
בוט: 📊 בחר תרחיש...

משתמש: אופטימיזציה
בוט: 🔄 מריץ אופטימיזציה...
```

## ⚙️ הגדרות

### משתני סביבה

הוסף ל-`.env.local`:
```env
CRON_SECRET=your-super-secret-key
```

### Vercel Cron

הקובץ `vercel.json` כבר מוגדר עם:
```json
{
  "crons": [
    {
      "path": "/api/cron/goals-check",
      "schedule": "0 10 * * *"
    }
  ]
}
```

זה מריץ את הבדיקה מדי יום ב-10:00 בוקר.

## 🎯 דוגמאות שימוש

### תרחיש 1: משתמש עם 3 יעדים

**מצב:**
- הכנסה: 15,000 ₪
- הוצאות קבועות: 9,000 ₪
- יעדים:
  1. קרן חירום - 30,000 ₪ (עדיפות 1)
  2. חופשה - 15,000 ₪ (עדיפות 3)
  3. רכב חדש - 50,000 ₪ (עדיפות 5)

**תוצאה:**
- זמין ליעדים: 3,600 ₪
- הקצאות:
  - קרן חירום: 2,000 ₪ (15 חודשים)
  - חופשה: 1,200 ₪ (10 חודשים)
  - רכב: 400 ₪ (125 חודשים)
- שנותר למחיה: 2,400 ₪ ✅
- המלצה: שקול להגדיל הכנסה כדי לקדם את יעד הרכב

### תרחיש 2: הכנסה עלתה

**לפני:**
- הכנסה: 12,000 ₪
- הקצאה לקרן חירום: 1,500 ₪

**אחרי עלייה של 3,000 ₪:**
- הכנסה: 15,000 ₪
- הקצאה חדשה לקרן חירום: 2,300 ₪ (+800 ₪)
- חיסכון בזמן: 5 חודשים 🎉
- התראה: "💰 הכנסתך עלתה! רוצה לעדכן יעדים?"

### תרחיש 3: יעד בסיכון

**מצב:**
- יעד "חתונה" - 40,000 ₪
- תאריך: 30/06/2026 (3 חודשים)
- הקצאה נוכחית: 5,000 ₪/חודש
- נותר: 25,000 ₪
- נדרש: 8,333 ₪/חודש

**התראה:**
```
⚠️ היעד "חתונה" בסיכון! נשארו 90 ימים והוא לא יושלם בזמן.
💡 המלצה: הגדל הקצאה ל-8,500 ₪/חודש או דחה תאריך
```

## 🔧 פתרון בעיות

### הקצאות נראות לא הגיוניות

**בדוק:**
1. האם `priority` מוגדר נכון? (1 = הכי חשוב)
2. האם `deadline` מוגדר? (משפיע על דחיפות)
3. האם `is_flexible` מוגדר? (יעדים לא גמישים מקבלים משקל גבוה יותר)

**פתרון:**
```sql
UPDATE goals 
SET priority = 1, is_flexible = false
WHERE name = 'קרן חירום';
```

### התראות לא נשלחות

**בדוק:**
1. האם ה-cron job רץ? (בדוק ב-Vercel Dashboard)
2. האם `CRON_SECRET` מוגדר?
3. האם למשתמש יש `phone` בטבלת `users`?

**בדיקה ידנית:**
```bash
curl -X POST https://your-domain.com/api/cron/goals-check \
  -H "Content-Type: application/json" \
  -d '{"userId": "user-uuid"}'
```

### סימולציה לא מוצגת בדשבורד

**בדוק:**
1. פתח Console בדפדפן - האם יש שגיאות?
2. בדוק network tab - האם ה-API מחזיר תשובה?
3. בדוק שהמשתמש מחובר (session valid)

## 📊 מטריקות ומדידה

**Dashboard Admin (TODO):**
- כמה משתמשים משתמשים במערכת היעדים?
- מה האחוז של יעדים שמושלמים בזמן?
- כמה התראות נשלחות בממוצע ליום?
- מה רמת המעורבות עם פיצ'ר הסימולציה?

**Query לבדיקה:**
```sql
SELECT 
  COUNT(DISTINCT user_id) as total_users_with_goals,
  COUNT(*) as total_goals,
  AVG(monthly_allocation) as avg_allocation
FROM goals 
WHERE status = 'active';
```

## 🎓 למידה והמלצות

המערכת לומדת לאורך זמן:
- שומרת היסטוריית הקצאות
- מזהה דפוסים בשינויי הכנסה
- מתאימה המלצות לפי התנהגות

**בעתיד (TODO):**
- למידת מכונה לחיזוי הכנסות מדויק יותר
- זיהוי דפוסים עונתיים (בונוסים, מס הכנסה)
- המלצות מותאמות אישית לפי פרופיל משתמש

## 📝 הערות חשובות

1. **"אוכל בצלחת"** - המערכת **אף פעם** לא תקצה יותר מ-70% מההכנסה ליעדים
2. **שקיפות** - המשתמש **תמיד** רואה למה המערכת הציעה מה שהציעה
3. **שליטה** - המשתמש **יכול** לדרוס כל הצעה (והמערכת תלמד מזה)
4. **ריאיזון** - כל פעם שההכנסה/הוצאות משתנות, מומלץ להריץ ריאיזון

## 🚀 Next Steps

רעיונות להמשך פיתוח:
- [ ] דף "Goals Timeline" - ציר זמן ויזואלי של כל היעדים
- [ ] "Goal Groups" - קיבוץ יעדים (משפחה, עסק, אישי)
- [ ] "Shared Goals" - יעדים משותפים לבני זוג
- [ ] "Milestone Celebrations" - חגיגות בהשגת אבני דרך
- [ ] "AI Coach" - מאמן AI שמציע טיפים מותאמים אישית
- [ ] "Investment Integration" - חיבור לתיקי השקעות (מניות, קריפטו)

---

**נבנה עם ❤️ ו-φ (Phi) - היחס הזהב של הכסף שלך**

