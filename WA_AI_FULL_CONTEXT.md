# 🧠 WhatsApp AI - Context מלא

תיעוד מפורט של המידע שהAI מקבל על כל משתמש בשיחות WhatsApp.

---

## 📊 **סקירה כללית**

כשמשתמש שולח הודעת WhatsApp, **פיני** (ה-AI) מקבל **9 קטגוריות מידע** על המשתמש:

1. ✅ **פרופיל פיננסי** - הכנסות, הוצאות, חובות, חיסכון
2. ✅ **שלב במסלול ההבראה** - reflection/foundation/building/thriving/sustaining
3. ✅ **תקציב חודשי** - תקציב נותר, ימים נותרים, סטטוס
4. ✅ **יעדים פעילים** - מטרות חיסכון/השקעה
5. ✅ **תנועות אחרונות** - 5 הוצאות אחרונות
6. ✅ **התראות אחרונות** - התראות מ-3 ימים אחרונים
7. ✅ **הלוואות פעילות** - הלוואות שאושרו/פעילות
8. ✅ **ביטוחים** - ביטוחים פעילים
9. ✅ **מנוי** - תוכנית מנוי, סטטוס

---

## 🗂️ **פירוט Context**

### 1️⃣ **פרופיל פיננסי**

**מקור:** טבלאות `users` + `user_financial_profile`

**שדות:**
```typescript
{
  name: string;              // שם המשתמש
  age: number;               // גיל
  monthlyIncome: number;     // הכנסה חודשית
  totalFixedExpenses: number; // הוצאות קבועות
  availableBudget: number;   // תקציב פנוי (הכנסה - הוצאות)
  totalDebt: number;         // סך חובות
  currentSavings: number;    // חיסכון נוכחי
}
```

**דוגמה:**
```
## פרופיל המשתמש:
- שם: ישראל ישראלי
- הכנסה חודשית: ₪15,000
- הוצאות קבועות: ₪8,500
- תקציב פנוי: ₪6,500
- חובות: ₪50,000
- חיסכון: ₪12,000
```

---

### 2️⃣ **שלב במסלול ההבראה (Phase)**

**מקור:** `users.phase`

**שדות:**
```typescript
{
  current: 'reflection' | 'foundation' | 'building' | 'thriving' | 'sustaining';
  progress: number; // 0-100
}
```

**תרגום השלבים:**
- `reflection` → הכרה עצמית
- `foundation` → יסודות
- `building` → בנייה
- `thriving` → שגשוג
- `sustaining` → שמירה

**דוגמה:**
```
## שלב נוכחי במסלול ההבראה:
- יסודות (50% הושלם)
```

---

### 3️⃣ **תקציב חודשי**

**מקור:** `budgets` (לחודש הנוכחי)

**שדות:**
```typescript
{
  totalBudget: number;      // תקציב כולל
  totalSpent: number;       // כבר הוצא
  remaining: number;        // נותר
  daysRemaining: number;    // ימים שנותרו בחודש
  status: 'ok' | 'warning' | 'exceeded'; // סטטוס
}
```

**דוגמה:**
```
## תקציב חודשי:
- תקציב: ₪6,000
- הוצאו: ₪4,200
- נותר: ₪1,800
- ימים נותרים: 12
- סטטוס: ✅ תקין
```

---

### 4️⃣ **יעדים פעילים**

**מקור:** `goals` (סטטוס `active`)

**שדות:**
```typescript
Array<{
  name: string;             // שם היעד
  targetAmount: number;     // סכום יעד
  currentAmount: number;    // סכום נוכחי
  progress: number;         // אחוזי התקדמות
}>
```

**דוגמה:**
```
## יעדים פעילים:
- טיול לחו״ל: ₪8,000 / ₪15,000 (53%)
- קורס מקצועי: ₪2,500 / ₪5,000 (50%)
```

---

### 5️⃣ **תנועות אחרונות**

**מקור:** `transactions` (5 אחרונות, סוג `expense`)

**שדות:**
```typescript
Array<{
  date: string;         // תאריך
  description: string;  // תיאור (vendor או category)
  amount: number;       // סכום
  category: string;     // קטגוריה
}>
```

**דוגמה:**
```
## 5 תנועות אחרונות:
- 25.10.2025: רמי לוי - ₪250 (קניות)
- 24.10.2025: קפה - ₪35 (בילויים)
- 23.10.2025: דלק - ₪200 (רכב)
- 22.10.2025: משלוח - ₪45 (אוכל)
- 21.10.2025: כרטיס אוטובוס - ₪15 (תחבורה)
```

---

### 6️⃣ **התראות אחרונות**

**מקור:** `alerts` (3 ימים אחרונים)

**שדות:**
```typescript
Array<{
  type: string;         // סוג התראה
  message: string;      // תוכן ההודעה
  createdAt: string;    // תאריך
}>
```

**דוגמה:**
```
## התראות אחרונות (3 ימים):
- [budget_exceeded] חרגת מהתקציב השבועי ב-200 ₪
- [goal_progress] התקרבת ל-50% מהיעד "טיול לחו״ל"!
```

---

### 7️⃣ **הלוואות פעילות**

**מקור:** `loans` (רק `active = true`)

**שדות:**
```typescript
Array<{
  type: string;                 // סוג הלוואה (משכנתא, הלוואה אישית, הלוואת רכב)
  lender: string;               // שם המלווה/בנק
  amount: number;               // יתרה נוכחית
  monthlyPayment: number;       // תשלום חודשי
  interestRate?: number;        // ריבית באחוזים
  remainingPayments?: number;   // תשלומים נותרים
}>
```

**דוגמה:**
```
## הלוואות פעילות:
- משכנתא (בנק הפועלים), יתרה: ₪1,689,773, תשלום חודשי: ₪9,800, ריבית: 3.5%, תשלומים נותרים: 240
- הלוואה אישית (בנק דיסקונט), יתרה: ₪89,485, תשלום חודשי: ₪1,433, ריבית: 7.75%, תשלומים נותרים: 80
- הלוואה אישית (בנק דיסקונט), יתרה: ₪9,932, תשלום חודשי: ₪592, ריבית: 7.75%, תשלומים נותרים: 19
- **סה״כ תשלומים חודשיים: ₪11,825**
```

---

### 8️⃣ **ביטוחים**

**מקור:** `insurance` (רק `active = true`)

**שדות:**
```typescript
Array<{
  type: string;             // סוג ביטוח
  provider: string;         // חברת ביטוח
  monthlyPremium: number;   // דמי ביטוח חודשי
  active: boolean;          // פעיל?
}>
```

**דוגמה:**
```
## ביטוחים פעילים:
- חיים (מגדל): ₪250/חודש
- רכב (הראל): ₪180/חודש
- בריאות (כללית): ₪120/חודש
```

---

### 9️⃣ **מנוי**

**מקור:** `subscriptions`

**שדות:**
```typescript
{
  plan: 'basic' | 'premium' | 'enterprise';
  status: 'active' | 'paused' | 'cancelled';
  billingCycle: 'monthly' | 'yearly';
}
```

**דוגמה:**
```
## מנוי:
- תוכנית: premium
- סטטוס: active
```

---

## 🔐 **אבטחה**

### **בידוד מלא בין משתמשים:**

✅ **כל query מסונן לפי `user_id`**

```typescript
// דוגמה:
const { data: profile } = await supabase
  .from('user_financial_profile')
  .select('*')
  .eq('user_id', userId)  // ✅ רק המשתמש הזה!
  .single();
```

✅ **הזיהוי נעשה דרך מספר הטלפון:**

```typescript
// משתמש שולח הודעה:
phoneNumber = "972547667775"

// מחפשים אותו במסד:
const { data: user } = await supabase
  .from('users')
  .select('id, name, wa_opt_in')
  .eq('phone', phoneNumber)
  .single();

// אם לא נמצא → שגיאה 404
// אם לא נתן הסכמה (wa_opt_in = false) → שגיאה 403
```

---

## 🚀 **איך זה עובד?**

### **Flow שלם:**

```
1. משתמש שולח הודעה ב-WhatsApp
   ↓
2. GreenAPI שולח webhook ל-/api/wa/webhook
   ↓
3. מחלצים מספר טלפון: phoneNumber = chatId.replace('@c.us', '')
   ↓
4. מחפשים משתמש: SELECT * FROM users WHERE phone = phoneNumber
   ↓
5. אם נמצא + wa_opt_in = true → מביאים את כל ה-Context
   ↓
6. שולחים ל-AI (GPT-4o) עם:
   - System Prompt (האישיות של פיני)
   - Context (כל המידע למעלה)
   - היסטוריית שיחה (5 הודעות אחרונות)
   - ההודעה החדשה
   ↓
7. AI עונה בעברית חמה ומעודדת
   ↓
8. שולחים את התשובה ב-WhatsApp
   ↓
9. שומרים את השיחה ב-chat_messages
```

---

## 📝 **דוגמת שיחה עם Context מלא**

**משתמש:** "איך אני עומד החודש?"

**Context שה-AI מקבל:**
```
## פרופיל המשתמש:
- שם: דוד כהן
- הכנסה חודשית: ₪15,000
- הוצאות קבועות: ₪8,500
- תקציב פנוי: ₪6,500

## שלב נוכחי במסלול ההבראה:
- יסודות (50% הושלם)

## תקציב חודשי:
- תקציב: ₪6,000
- הוצאו: ₪4,200
- נותר: ₪1,800
- ימים נותרים: 12
- סטטוס: ✅ תקין

## יעדים פעילים:
- טיול לחו״ל: ₪8,000 / ₪15,000 (53%)

## 5 תנועות אחרונות:
- 25.10.2025: רמי לוי - ₪250 (קניות)
- 24.10.2025: קפה - ₪35 (בילויים)
```

**תשובת AI:**
```
היי דוד! 👋

אתה במצב טוב! הוצאת 4,200 ₪ מתוך 6,000 ₪ שהגדרת.
נשארו לך עוד 1,800 ₪ ל-12 ימים - זה 150 ₪ ליום 💪

והיעד שלך לטיול בחו״ל מתקדם יפה! כבר 53% בדרך! 🌴
```

---

## ✅ **סיכום**

| קטגוריה | טבלה | מספר פריטים | הערות |
|---------|------|-------------|-------|
| פרופיל | users, user_financial_profile | 1 | תמיד זמין |
| Phase | users.phase | 1 | תמיד זמין |
| תקציב | budgets | 1 | רק אם הוגדר תקציב לחודש |
| יעדים | goals | עד 5 | רק יעדים פעילים |
| תנועות | transactions | 5 | 5 אחרונות |
| התראות | alerts | עד 3 | 3 ימים אחרונים |
| הלוואות | loan_applications | עד 5 | רק approved/active |
| ביטוחים | insurance | עד 10 | רק פעילים |
| מנוי | subscriptions | 1 | תמיד זמין |

---

## 🔧 **קבצים רלוונטיים**

- `lib/ai/system-prompt.ts` - הגדרת Context + בניית טקסט עברית
- `app/api/wa/webhook/route.ts` - שליפת Context מהמסד נתונים
- `types/database.types.ts` - טיפוסי TypeScript

---

## 📈 **שיפורים עתידיים**

- [ ] חישוב `progress` אמיתי לפי הפעולות שהמשתמש ביצע
- [ ] הוספת מידע על subscriptions (נטפליקס, ספוטיפיי)
- [ ] סיכום חודשי אוטומטי
- [ ] תחזיות AI על בסיס היסטוריה

---

**📅 תאריך עדכון אחרון:** 25 אוקטובר 2025  
**✨ סטטוס:** ✅ פעיל ועובד

